# Network Layer
Transport Layer가 process간의 통신을 지원했다면, Network Layer는 호스트간의 데이터 교환을 지원한다. 이때 데이터를 데이터그램 또는 패킷이라고 부른다.

# Network Layer가 하는 일
## Forwarding
패킷을 목적지로 전송하는 것을 의미

## Routing
1. 패킷을 어떤 경로로 보낼지 결정하는 것을 의미
2. Forwarding Table을 라우팅 알고리즘을 통해 만들고 해당 Table에는 각 목적지에 따라 보내는 경로가 적혀있다.
3. 이때 Forwarding Table은 일대일대응 관계가 아니라 범위를 지정해서 특정 범위에 해당하는 주소는 어떤 경로로 보낼지 결정된다.(용량 극복)
4. Forwarding Table은 주변 라우터들과의 정보교환을 통해 만들어진다.
5. 매칭할때는 Longest Prefix Matching으로 어떤 경로로 보낼지 결정한다.

# IP Protocol
Network Layer의 대표적인 프로토콜. 사실상 IP 프로토콜 하나만 쓴다해도 과언이 아니다.

## Datagram Header 구조

### 헤더 사이즈
TCP/IP 프로토콜이라면 TCP에서 20바이트, IP에서 20바이트 총 40바이트다.

### Time to Live
1. 네트워크 상에서 사이클을 형성하며 무한히 떠도는 패킷을 우려해 만든 헤더 정보
2. 이 패킷이 얼마나 많은 라우터를 거칠 수 있는지를 의미한다. 라우터를 거칠때마다 1만큼 감소한다.
3. 0이 되면 라우터에서 드랍한다.

### Upper Layer
1. Network Layer에서 Transport Layer로 디캡슐화하고 세그먼트를 올려야하는데 TCP인지 UDP인지 알아야 하기 때문에 존재한다.

### 출발/목적지 IP 주소

# IPv4
호스트마다 유일한 32bit 주소를 부여한다.

## 단순 무작위로 부여할까?
1. 무작위로 부여하게 되면 Forwarding table 용량이 커지게된다. 
2. 따라서 계층화하여 체계적으로 부여하는데 이때 앞단의 Xbit를 네트워크주소, 나머지 32-Xbit를 host 주소로 사용한다.
3. subnet mask를 통해 네트워크 주소를 판별할 수 있다.
4. 위와 같은 방법이면 새로운 주소 추가가 용이하다.

# CIDR
1. 클래스 없는 도메인 간의 라우팅 기법으로 네트워크 클래스를 대체하였다.
2. 어떤 IP주소의 최상위 X비트를 네트워크 주소로 잡는다. 이를 해당 주소의 prefix라고 부른다.
3. 이 경우 하나의 기관 장비들의 IP주소는 공통 프리픽스를 공유하게 된다.
4. 나머지 32-X비트는 같은 기관 내부에 있는 모든 장비를 구별한다고 보면 된다.
5. CIDR을 사용하게 된 이유는 클래스 주소체계의 비효율성을 극복하기 위함이다. 

# 인터페이스
1. 인터페이스란 호스트와 물리적 링크 사이의 경계를 말한다. 
2. 사실 ip주소는 특정 호스트의 주소라기보단 인터페이스의 주소라고 보는게 맞다.
3. 라우터의 경우 특성상 인터페이스가 많을 수 밖에 없는데 각 인터페이스마다 IP주소는 다르다.

# Subnet
1. 라우터를 거치지 않고 연결되어있는 인터페이스의 집합
2. 223.1.1.0/24 라는 서브넷 주소가 있다면 이때 /24를 서브넷 마스크라고 부르고 이는 왼쪽 24비트가 서브넷 주소라는 것을 의미한다.

# DHCP
1. 동적 호스트 구성 프로토콜 (Dynamic Host Configuration Protocol)
2. 네트워크 내의 호스트에게 자동으로 DNS 네임 서버 주소, IP주소, 게이트웨이 주소를 할당해주고 해당 클라이언트에게 IP주소를 일정기간 임대를 하는 프로토콜.

## DHCP 장점
1. 어떤 사용자가 물리적으로 위치를 계속 바꾸면서 네트워크에 접속한다고 생각해보자.
2. 해당 사용자는 이동하면서 서로 다른 서브넷에 접속할 것이며 각 지역마다 새로운 IP주소가 필요하다.
3. 만약 IP주소를 수동으로 관리자가 직접 부여하는 것은 상상할 수 없다. 따라서 자동으로 IP주소를 임대해주는 DHCP는 네트워크 관리를 편리하게 해준다.

## DHCP 원리
1. 새로운 호스트가 DHCP서버를 찾는다. 이때 브로드캐스트 IP주소로 설정하여 서브넷에 연결된 모든 노드로 DHCP 검색 IP 데이터그램을 전송한다.
2. DHCP 검색 메시지를 받은 DHCP 서버는 임대가능한 IP주소와 함께 DHCP 제공 메시지를 클라이언트로 응답한다. 이때에도 브로드캐스트로 전송한다. 
3. DHCP 메시지를 받은 호스트는 서버의 존재를 확인하고 해당 서버에게 DHCP 요청메시지를 브로드캐스트로 보낸다.
4. DHCP 서버는 DHCP ACK 메시지를 클라이언트에게 전송하고 IP를 임대해준다. 이 역시 브로드캐스트다.

## 왜 브로드캐스트를 쓰는거지?
1. 클라이언트가 DHCP 서버를 찾기위해 브로드캐스트를 하는 것은 이해가 된다.
2. 서버는 왜 클라이언트에게 브로드캐스트로 응답하는 것일까?
3. 답은 일부 클라이언트는 IP주소를 제대로 받기 전에 Unicast된 IP 데이터그램을 받을 수 없게 구현됐기 때문이라고 한다.

# NAT
1. Network Address Translation (네트워크 주소 변환)
2. 외부망(공인망)과 내부망(사설망)을 구분해주는 기능.
3. 사설 네트워크에 속한 여러 개의 호스트가 하나의 공인 IP주소를 사용하여 인터넷에 접속하게 하는 기능.

## NAT를 사용하는 이유
### IP 주소 절약
1. 하나의 공인 IP주소로 여러대의 호스트가 인터넷에 접속가능.
2. 인터넷 공유기가 NAT를 사용함.

### 보안
1. NAT 동작 특성상 IP를 숨길 수 있음.
2. 사설 IP가 공인 IP주소로 바뀌므로 공격자 입장에서 라우터 안쪽에 있는 사설 IP를 알 수 없음.

## 동작
1. 주소 공간 10.0.0.0/8 은 사설망을 위해 이미 예약된 IP주소 공간 중 하나이다.
2. 사설망 내의 호스트가 외부 웹 서버와 통신하기 위해 IP주소 A와 port 번호 a를 갖고 웹 서버 IP주소인 B에게 port 번호 80으로 요청했다고 가정.
3. NAT 가능 라우터는 해당 메시지를 받으면 source IP주소를 자신의 공인 IP주소로 변경하고 포트번호도 C로 바꿔서 보낸다. 그리고 해당 정보를 NAT 변환 테이블에 기록.
4. 라우터는 웹 서버로부터 응답이오면 NAT 변환 테이블을 보고 port 번호 C를 확인하고 여기에 매칭되는 IP주소 A에게 응답을 전달한다.

## Port 번호는 왜 바꾸는거지?
1. 하나의 웹 서버에 다수의 호스트가 요청 메시지를 보낸다고 생각해보자.
2. 사설망 내의 다수의 호스트는 각각 IP주소가 다르지만 NAT 라우터는 IP주소가 하나뿐이다.
3. 웹 서버입장에서는 서로 다른 호스트가 보낸 요청이지만 같은 IP주소이므로 구분이 불가능하다.
4. 따라서 port 번호를 충돌안나게끔 라우터가 재설정하여 웹 서버가 구분할 수 있게 하는 것이다. 


